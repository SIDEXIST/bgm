<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG BGM from Youtube</title>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; display: none; } /* ë¡œê·¸ì¸ ì „ê¹Œì§€ ìˆ¨ê¹€ */
        
        /* ë£¸ ì…ì¥ í™”ë©´ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid #333; text-align: center; width: 300px; }
        
        /* ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ ë ˆì´ì–´ */
        #audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        
        /* í”Œë ˆì´ì–´ ìˆ¨ê¹€ ì²˜ë¦¬ */
        #players-container { width: 1px; height: 1px; overflow: hidden; position: absolute; opacity: 0; }
        
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        input, button { background: #2c2c2c; color: #fff; border: 1px solid #444; padding: 12px; border-radius: 6px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: #3700b3; border: none; font-weight: bold; }
        button:hover { background: #6200ee; }
        .host-only { display: none; }
        
        /* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .playlist-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; cursor: grab; }
        .playlist-item.dragging { opacity: 0.5; border: 2px dashed var(--primary); }
        .item-main { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .item-meta { font-size: 0.7rem; color: #666; }
        .btn-group { display: flex; gap: 4px; }
        .small-btn { padding: 4px 8px; font-size: 0.7rem; width: auto; }
        
        /* ë‹¤ì¤‘ ì¬ìƒ ìƒíƒœ í‘œì‹œ */
        .active-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--accent); color: #000; font-weight: bold; margin-left: 5px; display: none; }
        .playing-now .active-tag { display: inline; }

        #log-area { font-size: 0.7rem; color: #888; background: #000; padding: 10px; border-radius: 5px; height: 80px; overflow-y: auto; margin-top: 10px; border: 1px solid #333; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color:var(--primary); font-size: 1.2rem; margin-bottom: 20px;">TRPG BGM from Youtube</h1>
            <input type="text" id="input-room-name" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="enterRoom('host')">í˜¸ìŠ¤íŠ¸ë¡œ ì…ì¥</button>
            <button onclick="enterRoom('guest')" style="background:#444">ê²ŒìŠ¤íŠ¸ë¡œ ì…ì¥</button>
            <p style="font-size:0.7rem; color:#666; margin-top:10px;">* í˜¸ìŠ¤íŠ¸ëŠ” ë°©ì„ ìƒì„±/ê´€ë¦¬í•˜ê³ ,<br>ê²ŒìŠ¤íŠ¸ëŠ” ê³µìœ ëœ ìŒì•…ì„ ë“£ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <div id="audio-unlock" onclick="unlockAudio()">
        <div style="font-size: 60px;">ğŸ§</div>
        <b>í´ë¦­í•˜ì—¬ ì„¸ì…˜ ì‚¬ìš´ë“œ í™œì„±í™”</b>
    </div>

    <div class="container" id="main-container">
        <div class="card">
            <h2 style="color: var(--primary); margin: 0 0 10px 0; font-size: 1rem;">ROOM: <span id="room-display"></span></h2>
            <div id="players-container"></div> <div id="active-list-display" style="font-size: 0.85rem;">
                <p style="margin:0; color:#888;">í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë ˆì´ì–´:</p>
                <div id="active-tracks-names" style="color:var(--accent); font-weight:bold; margin-top:5px;">-</div>
            </div>
        </div>

        <div id="host-panel" class="host-only card">
            <h3 style="margin-top:0; font-size: 0.9rem;">ê³¡ ì¶”ê°€</h3>
            <input type="text" id="yt-url" placeholder="ìœ íŠœë¸Œ URL">
            <input type="text" id="custom-title" placeholder="í‘œì‹œ ì œëª©">
            <div style="display:flex; align-items:center; gap:10px; font-size:0.85rem; margin:5px 0;">
                <span>í•œê³¡ ë°˜ë³µ</span><input type="checkbox" id="is-loop" style="width:auto;">
            </div>
            <button onclick="addToPlaylist()" style="background:#444">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</button>
            <div style="display: flex; gap: 5px;">
                <button onclick="savePlaylist()" style="flex:1; background:#333; font-size:0.7rem;">ğŸ’¾ ë¦¬ìŠ¤íŠ¸ ì €ì¥</button>
                <button onclick="document.getElementById('file-input').click()" style="flex:1; background:#333; font-size:0.7rem;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="resetServerData()" style="flex:1; background:#b71c1c; font-size:0.7rem;">ğŸ§¹ ë°© ì´ˆê¸°í™”</button>
            </div>
            <input type="file" id="file-input" style="display:none" onchange="loadPlaylist(event)">
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size: 0.9rem;">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ (ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½)</h3>
            <div id="playlist-container"></div>
            <div id="log-area">ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // [ë¡œê·¸]
        function log(msg) {
            const area = document.getElementById('log-area');
            area.innerHTML += `<div>> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
            console.log(msg);
        }

        // [Firebase ì„¤ì •]
        const firebaseConfig = {
            apiKey: "AIzaSyCmuKgORZHasMoHTfldQdN8AEBYwR2uOQ0",
            authDomain: "trpg-bgm-from.firebaseapp.com",
            databaseURL: "https://trpg-bgm-from-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "trpg-bgm-from",
            storageBucket: "trpg-bgm-from.firebasestorage.app",
            messagingSenderId: "731757785916",
            appId: "1:731757785916:web:f02ee6e3d03f5e91856439"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomId = "";
        let isHost = false;
        let playlist = [];
        let players = {}; // videoIdë³„ í”Œë ˆì´ì–´ ê°ì²´ ì €ì¥

        // [í•¨ìˆ˜] ë£¸ ì…ì¥ (ìš”êµ¬ì‚¬í•­ 3)
        function enterRoom(role) {
            const name = document.getElementById('input-room-name').value.trim();
            if (!name) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            roomId = name;
            isHost = (role === 'host');
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('audio-unlock').style.display = 'flex';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('room-display').innerText = roomId;
            
            if (isHost) document.querySelectorAll('.host-only').forEach(el => el.style.display = 'block');
            
            initSync();
            log(`${roomId} ë°©ì— ${isHost ? 'í˜¸ìŠ¤íŠ¸' : 'ê²ŒìŠ¤íŠ¸'}ë¡œ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
        }

        // [í•¨ìˆ˜] ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ
        function unlockAudio() {
            document.getElementById('audio-unlock').style.display = 'none';
            log("ì˜¤ë””ì˜¤ ì¥ì¹˜ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // [ë™ê¸°í™”] ë‹¤ì¤‘ ì¬ìƒ ë™ê¸°í™” (ìš”êµ¬ì‚¬í•­ 4)
        function initSync() {
            db.ref(`rooms/${roomId}/active`).on('value', async (snap) => {
                const activeData = snap.val() || {};
                const activeIds = Object.keys(activeData);
                
                // 1. ì´ë¦„ í‘œì‹œ ì—…ë°ì´íŠ¸
                const names = activeIds.map(id => activeData[id].title).join(', ') || '-';
                document.getElementById('active-tracks-names').innerText = names;

                // 2. í”Œë ˆì´ì–´ ê´€ë¦¬ (ì¶”ê°€ëœ ê³¡ ì¬ìƒ)
                activeIds.forEach(vid => {
                    if (!players[vid]) {
                        createPlayer(vid, activeData[vid].loop);
                    } else {
                        // ì´ë¯¸ ìˆë‹¤ë©´ ìƒíƒœ í™•ì¸ (ì¬ìƒ/ì •ì§€ ë“±)
                        const p = players[vid];
                        if (p.getPlayerState && activeData[vid].status === 'playing') p.playVideo();
                        if (p.getPlayerState && activeData[vid].status === 'paused') p.pauseVideo();
                    }
                });

                // 3. ì œê±°ëœ ê³¡ ì •ì§€ ë° ì‚­ì œ
                Object.keys(players).forEach(vid => {
                    if (!activeData[vid]) {
                        players[vid].stopVideo();
                        players[vid].destroy();
                        document.getElementById(`player-${vid}`)?.remove();
                        delete players[vid];
                        log(`ì •ì§€: ${vid}`);
                    }
                });
                
                render(); // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ UI ìƒíƒœ ì—…ë°ì´íŠ¸
            });
        }

        // [í•¨ìˆ˜] ê°œë³„ í”Œë ˆì´ì–´ ìƒì„±
        function createPlayer(vid, loop) {
            const div = document.createElement('div');
            div.id = `player-${vid}`;
            document.getElementById('players-container').appendChild(div);

            players[vid] = new YT.Player(`player-${vid}`, {
                height: '1', width: '1',
                videoId: vid,
                playerVars: { 'autoplay': 1, 'controls': 0, 'playsinline': 1 },
                events: {
                    'onReady': (e) => { e.target.playVideo(); log(`ì¬ìƒ ì‹œì‘: ${vid}`); },
                    'onStateChange': (e) => {
                        if (e.data === YT.PlayerState.ENDED && loop) e.target.playVideo();
                    }
                }
            });
        }

        // [í•¨ìˆ˜] ê³¡ ì¶”ê°€
        async function addToPlaylist() {
            const url = document.getElementById('yt-url').value;
            const vid = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1];
            if (!vid) return alert("URLì„ í™•ì¸í•˜ì„¸ìš”.");

            let title = document.getElementById('custom-title').value;
            if (!title) {
                const res = await fetch(`https://noembed.com/embed?url=${url}`);
                const data = await res.json();
                title = data.title || "BGM";
            }

            playlist.push({
                id: vid,
                title: title,
                url: url,
                loop: document.getElementById('is-loop').checked
            });
            render();
            document.getElementById('yt-url').value = "";
            document.getElementById('custom-title').value = "";
        }

        // [UI] í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ + ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ìš”êµ¬ì‚¬í•­ 1, 2, 3)
        function render() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '';

            playlist.forEach((item, i) => {
                const isActive = !!players[item.id];
                const div = document.createElement('div');
                div.className = `playlist-item ${isActive ? 'playing-now' : ''}`;
                div.draggable = isHost;
                div.innerHTML = `
                    <div class="item-main">
                        <span>${item.title} <span class="active-tag">ON</span></span>
                        <div class="btn-group">
                            ${isHost ? `
                                <button class="small-btn" onclick="toggleLoop(${i})">${item.loop ? 'ğŸ”„ ë£¨í”„ ì¤‘' : 'â¡ï¸ 1íšŒ'}</button>
                                <button class="small-btn" onclick="togglePlay('${item.id}', '${item.title}', ${item.loop})">${isActive ? 'STOP' : 'PLAY'}</button>
                                <button class="small-btn" onclick="editTitle(${i})" style="background:#555">ìˆ˜ì •</button>
                                <button class="small-btn" onclick="removeTrack(${i})" style="background:#b71c1c">X</button>
                            ` : ''}
                        </div>
                    </div>
                    ${isHost ? `<div class="item-meta">ğŸ”— ${item.id} / ì›ì œ: ${item.title}</div>` : ''}
                `;

                // ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ìš”êµ¬ì‚¬í•­ 1)
                div.addEventListener('dragstart', () => div.classList.add('dragging'));
                div.addEventListener('dragend', () => {
                    div.classList.remove('dragging');
                    saveOrder();
                });
                container.appendChild(div);
            });

            container.addEventListener('dragover', e => {
                e.preventDefault();
                const draggingItem = document.querySelector('.dragging');
                const siblings = [...container.querySelectorAll('.playlist-item:not(.dragging)')];
                const nextSibling = siblings.find(sibling => e.clientY <= sibling.offsetTop + sibling.offsetHeight / 2);
                container.insertBefore(draggingItem, nextSibling);
            });
        }

        // [í•¨ìˆ˜] ìˆœì„œ ì €ì¥
        function saveOrder() {
            const currentTitles = [...document.querySelectorAll('.playlist-item span:first-child')].map(el => el.innerText.replace(' ON', '').trim());
            const newPlaylist = [];
            currentTitles.forEach(title => {
                const track = playlist.find(p => p.title === title || title.startsWith(p.title));
                if (track) newPlaylist.push(track);
            });
            playlist = newPlaylist;
            log("í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // [í•¨ìˆ˜] ê°œë³„ ì¬ìƒ í† ê¸€ (ë‹¤ì¤‘ ì¬ìƒ í•µì‹¬)
        function togglePlay(vid, title, loop) {
            const ref = db.ref(`rooms/${roomId}/active/${vid}`);
            if (players[vid]) {
                ref.remove();
            } else {
                ref.set({ title: title, status: 'playing', loop: loop });
            }
        }

        // [í•¨ìˆ˜] ë£¨í”„ í† ê¸€ (ìš”êµ¬ì‚¬í•­ 2)
        function toggleLoop(i) {
            playlist[i].loop = !playlist[i].loop;
            render();
            log(`${playlist[i].title}ì˜ ë£¨í”„ ì„¤ì •ì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);
        }

        function editTitle(i) {
            const n = prompt("ìƒˆ ì œëª©:", playlist[i].title);
            if(n) { playlist[i].title = n; render(); }
        }

        function removeTrack(i) {
            playlist.splice(i, 1);
            render();
        }

        function resetServerData() {
            if(confirm("ì„œë²„ì˜ ëª¨ë“  ì¬ìƒ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
                db.ref(`rooms/${roomId}`).remove();
                location.reload();
            }
        }

        function savePlaylist() {
            const blob = new Blob([JSON.stringify(playlist)], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob); a.download = `playlist_${roomId}.json`; a.click();
        }

        function loadPlaylist(e) {
            const reader = new FileReader();
            reader.onload = (ev) => { playlist = JSON.parse(ev.target.result); render(); };
            reader.readAsText(e.target.files[0]);
        }

        function onYouTubeIframeAPIReady() { log("YouTube API Ready."); }
    </script>
</body>
</html>