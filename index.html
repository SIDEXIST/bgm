<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG BGM from Youtube</title>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #00ffff; --grey: #333; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 650px; display: none; }
        
        /* ëª¨ë‹¬ ì‹œìŠ¤í…œ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 340px; border: 1px solid var(--accent); box-sizing: border-box; }
        
        /* ì…ì¥ ë° ì‚¬ìš´ë“œ í™œì„±í™” */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid #333; text-align: center; width: 340px; }
        #audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 40000; display: none; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        
        /* ë ˆì´ì•„ì›ƒ ê³µí†µ */
        #players-container { width: 1px; height: 1px; overflow: hidden; position: absolute; opacity: 0; }
        .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
        .flex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
        
        h2, h3, .vol-title { color: var(--primary); margin: 0; font-size: 1.05rem; font-weight: bold; }
        .section-title { color: #fff; text-shadow: 0 0 10px rgba(0,255,255,0.3); margin-top: 15px; margin-bottom: 12px; font-size: 0.9rem; font-weight: bold; }

        input, button { background: #2c2c2c; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; margin: 4px 0; box-sizing: border-box; }
        button { cursor: pointer; border: none; font-weight: bold; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; }

        /* My Master Volume */
        .guest-master-vol { background: #333; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--accent); }
        .vol-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 5px; }
        .vol-desc { font-size: 0.65rem; color: #888; flex: 1; text-align: left; }

        /* í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM (2ë‹¨ êµ¬ì„±) */
        .active-track-item { background: #252525; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid var(--accent); }
        .active-title-line { font-weight: bold; color: var(--accent); font-size: 0.95rem; margin-bottom: 15px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .active-controls-line { display: flex; gap: 4px; align-items: center; width: 100%; }
        
        .btn-status { height: 28px; font-size: 0.65rem; background: var(--primary); color: #000; flex: 1; border-radius: 4px; padding: 0; min-width: 45px; }
        .btn-status.active { background: var(--accent) !important; font-weight: 800; }
        .btn-delete { background: #444; color: #fff; flex: 1.2 !important; min-width: 55px; }
        .btn-vol-lavender { background: var(--primary) !important; color: #000 !important; font-weight: bold; }

        .slider-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; width: 100%; }
        input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 3px; outline: none; background: #222; border: 1px solid #333; flex: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--accent); cursor: pointer; }
        .vol-slider { background: linear-gradient(to right, var(--accent) 0%, var(--accent) var(--p), #444 var(--p)) !important; border: none !important; }
        .time-text { font-size: 0.65rem; color: #888; min-width: 80px; text-align: right; font-family: monospace; }

        /* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ */
        .playlist-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; cursor: grab; user-select: none; }
        .item-main { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; }
        .btn-group { display: flex; gap: 4px; align-items: center; }
        
        .small-btn { height: 26px; font-size: 0.65rem; border-radius: 4px; width: 50px; text-align: center; margin: 0; flex-shrink: 0; }
        .btn-vol-large { width: 75px !important; } 
        .btn-play-toggle { width: 60px; } 
        .btn-play-toggle.on { background: var(--accent) !important; font-weight: 800; }
        
        .item-meta { font-size: 0.65rem; color: #777; margin-top: 8px; display: flex; align-items: center; gap: 8px; overflow: hidden; white-space: nowrap; }
        .meta-link { color: #777; text-decoration: none; font-family: monospace; flex-shrink: 0; font-size: 0.65rem; }
        .meta-title { color: #777; overflow: hidden; text-overflow: ellipsis; flex: 1; font-size: 0.65rem; }

        /* ì ‘ì†ì ë° ë¡œê·¸ */
        #user-list-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .user-tag { display: flex; align-items: center; padding: 0 10px; height: 24px; border-radius: 20px; background: #333; font-size: 0.75rem; border: 1px solid #444; color: #ccc; }
        .user-tag.host { border-color: var(--primary); color: var(--primary); }
        #log-area { font-size: 0.8rem; color: #aaa; background: #000; padding: 12px; border-radius: 5px; height: 100px; overflow-y: auto; border: 1px solid #333; line-height: 1.5; }
        
        /* [ì¤‘ìš”] ê³¡ ì¶”ê°€ 3ì¤„ êµ¬ì„± ê°•ì œ ìŠ¤íƒ€ì¼ */
        .add-music-header-controls { display: flex; align-items: center; gap: 10px; }
        .loop-label-wrapper { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; cursor: pointer; color: #888; white-space: nowrap; }
        .header-btn { width: auto; padding: 4px 10px; font-size: 0.65rem; margin: 0; background: #444; height: 26px; }
        /* ì…ë ¥ë€ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .input-row { width: 100%; margin-bottom: 8px; } 
        .input-row:last-child { margin-bottom: 0; }
        /* ì…ë ¥ë€ ìì²´ ìŠ¤íƒ€ì¼ */
        .input-row input { width: 100%; margin: 0; } 

        .footer { text-align: center; font-size: 0.6rem; color: #444; margin-top: 30px; margin-bottom: 20px; }
        .host-only { display: none; }
    </style>
</head>
<body>

    <div id="edit-modal" class="modal-overlay"><div class="modal-content"><h3 style="color:var(--accent); margin-bottom:15px;">ì •ë³´ ìˆ˜ì •</h3><input type="text" id="edit-title" placeholder="ì œëª©"><input type="text" id="edit-url" placeholder="ìœ íŠœë¸Œ URL"><div style="display:flex; gap:8px; margin-top:15px;"><button onclick="closeModal('edit-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button><button onclick="saveEdit()" style="flex:1; background:var(--accent); color:#000;">ì €ì¥</button></div></div></div>
    <div id="vol-modal" class="modal-overlay"><div class="modal-content"><h3 style="color:var(--accent); margin-bottom:15px;">ë³¼ë¥¨ ì„¤ì •</h3><p id="vol-modal-target" style="font-size:0.75rem; color:#888; margin-bottom:10px;"></p><input type="number" id="vol-input-box" min="0" max="100"><div style="display:flex; gap:8px; margin-top:15px;"><button onclick="closeModal('vol-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button><button onclick="saveVolumeFromModal()" style="flex:1; background:var(--accent); color:#000;">ì ìš©</button></div></div></div>
    <div id="reset-modal" class="modal-overlay"><div class="modal-content"><h3 style="color:var(--primary); margin-bottom:15px;">ë°© ë°ì´í„° ì´ˆê¸°í™”</h3><p style="font-size:0.8rem; color:#bbb; line-height:1.6;">í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ëª¨ë“  ê³¡ì„ ì¤‘ë‹¨í•˜ê³  ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</p><div style="display:flex; gap:8px; margin-top:15px;"><button onclick="closeModal('reset-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button><button onclick="executeSoftReset()" style="flex:1; background:#b71c1c; color:#fff;">ì´ˆê¸°í™” ì‹¤í–‰</button></div></div></div>
    <div id="delete-modal" class="modal-overlay"><div class="modal-content"><h3 style="color:#b71c1c; margin-bottom:15px;">ê³¡ ì‚­ì œ í™•ì¸</h3><p id="delete-target-name" style="font-size:0.75rem; color:#888; margin-bottom:20px;"></p><div style="display:flex; gap:8px;"><button onclick="closeModal('delete-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button><button id="confirm-delete-btn" style="flex:1; background:#b71c1c; color:#fff;">ì‚­ì œ</button></div></div></div>

    <div id="login-screen"><div class="login-card"><h1 id="login-title" style="color:var(--accent); font-size: 1rem; margin-bottom: 15px;">TRPG BGM from Youtube</h1><input type="text" id="input-room-name" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"><input type="text" id="input-nickname" placeholder="ë‹‰ë„¤ì„"><button id="btn-host-login" onclick="enterRoom('host')" style="background:var(--primary); color:#000;">ë°© ìƒì„± (í˜¸ìŠ¤íŠ¸)</button><button id="btn-guest-login" onclick="enterRoom('guest')" style="background:var(--accent); color:#000; display:none;">ì…ì¥</button><div id="guest-msg" style="display:none; margin-top:15px; font-size:0.8rem; color:#888;">ë§í¬ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì…ì¥í•˜ì„¸ìš”.</div></div></div>
    <div id="audio-unlock" onclick="unlockAudio()"><div style="font-size: 50px;">ğŸ§</div><b>ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ í™œì„±í™”</b></div>

    <div class="container" id="main-container">
        <div class="guest-master-vol"><div class="vol-header"><span class="vol-title">My Master Volume</span><p class="vol-desc" style="padding-left:10px;">* ë‚˜ì—ê²Œë§Œ ì ìš©ë˜ëŠ” ìŒëŸ‰ì…ë‹ˆë‹¤.</p><span id="guest-vol-text" style="font-size:0.75rem; color:var(--accent); cursor:pointer; text-decoration:underline;" onclick="openVolModal('master')">100%</span></div><input type="range" id="guest-master-slider" min="0" max="100" value="100" oninput="changeMyMasterVolume(this.value)" class="vol-slider" style="--p:100%; width:100%;"></div>

        <div class="card"><div class="flex-header"><h2>ROOM: <span id="room-display"></span></h2><button onclick="copyInviteLink()" style="width:auto; padding:5px 10px; font-size:0.65rem; background:#444;">ë§í¬ ë³µì‚¬</button></div><div id="players-container"></div><p class="section-title">í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM</p><div id="active-tracks-ui"></div></div>

        <div id="host-panel" class="host-only card" style="display: none; flex-direction: column;"> <div class="flex-header" style="margin-bottom: 10px;">
                <h3>ê³¡ ì¶”ê°€</h3>
                <div class="add-music-header-controls">
                    <label class="loop-label-wrapper">
                        <input type="checkbox" id="is-loop" style="width:auto; margin:0; vertical-align:middle;">
                        ë°˜ë³µ
                    </label>
                    <button onclick="addToPlaylist()" style="background:var(--accent); color:#000; width:60px; height:26px; padding:0;">ì¶”ê°€</button>
                </div>
            </div>
            <div class="input-row">
                <input type="text" id="yt-url" placeholder="Youtube URL">
            </div>
            <div class="input-row">
                <input type="text" id="custom-title" placeholder="í‘œì‹œ ì œëª©">
            </div>
        </div>

        <div class="card"><div class="flex-header"><h3 id="playlist-header">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h3><div class="host-only" style="display:flex; gap:4px;"><button class="header-btn" onclick="savePlaylistFile()">ì €ì¥</button><button class="header-btn" onclick="document.getElementById('file-input').click()">ì—´ê¸°</button><button class="header-btn" style="background:#b71c1c;" onclick="openResetModal()">ì´ˆê¸°í™”</button></div></div><div id="playlist-container"></div><input type="file" id="file-input" style="display:none" onchange="loadPlaylist(event)"></div>

        <div class="card"><h3>ì ‘ì†ì (<span id="user-count">0</span>)</h3><div id="user-list-container"></div></div>
        <div class="card"><h3>ì‹œìŠ¤í…œ ë¡œê·¸</h3><div id="log-area">ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div></div>

        <div class="footer">ë¬¸ì˜: Twitter @SIHAST</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // ... (ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ê³¼ ë™ì¼) ...
        // ë‹¨, enterRoom í•¨ìˆ˜ì—ì„œ í˜¸ìŠ¤íŠ¸ íŒ¨ë„ í‘œì‹œ ë°©ì‹ ìˆ˜ì •
        async function enterRoom(role) {
            // ... (ê¸°ì¡´ ë¡œì§) ...
            if (isHost) window.history.replaceState({}, '', `?room=${roomId}&h=1`);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('audio-unlock').style.display = 'flex';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('room-display').innerText = roomName;
            
            // [ìˆ˜ì •] í˜¸ìŠ¤íŠ¸ íŒ¨ë„ì˜ display ì†ì„±ì„ ëª…í™•íˆ ì„¤ì •
            if (isHost) {
                document.querySelectorAll('.host-only').forEach(el => el.style.display = 'flex');
                // ê³¡ ì¶”ê°€ ì˜ì—­ì€ ë³„ë„ì˜ flex-directionì´ í•„ìš”í•˜ë¯€ë¡œ ë”°ë¡œ ì§€ì •í•˜ì§€ ì•Šê³  CSSì˜ ê¸°ë³¸ ë™ì‘ì„ ë”°ë¥´ê²Œ í•¨ (HTML íƒœê·¸ì— ì§ì ‘ style="display: none; flex-direction: column;" ì¶”ê°€ í›„, ì—¬ê¸°ì„œëŠ” display: flexë§Œ ì ìš©)
            }

            // [ìˆ˜ì •] ì„œë²„ë¡œë¶€í„° í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë™ê¸°í™”
            db.ref(`rooms/${roomId}/playlist`).on('value', (snap) => {
                playlist = snap.val() || [];
                render();
            });

            setupPresence(); initSync(); setInterval(updateAllProgress, 1000);
        }
        // ... (ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ ê¸°ì¡´ ìœ ì§€) ...
    </script>
</body>
</html>